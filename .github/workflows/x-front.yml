# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  IMAGE_NAME: toolod/x-frontserver

jobs:
  build-and-deploy:
    name: Build, Publish & Deploy
    runs-on: ubuntu-latest        # ‚Üê GitHub-hosted runner
    outputs:
      VERSION_TAG: ${{ steps.make-version.outputs.VERSION_TAG }}
    steps:
      - name: üõéÔ∏è Checkout X-frontServer
        uses: actions/checkout@v4
        with: 
          repository: keyveloper/X-FrontServer
          path: x-frontserver

      - name: üîß Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: üÜî Compute VERSION_TAG
        id: make-version
        run: |
          TAG="1.0.0-$(date +%Y%m%d)-$(uuidgen | cut -c1-7)"
          echo "VERSION_TAG=$TAG" >> $GITHUB_ENV
          echo "::set-output name=VERSION_TAG::$TAG"

      - name: Switch to Front and build Gradle 
        run: |
          cd x-frontserver
          gradle clean build --no-daemon

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: frontserver-jar
          path: x-frontserver/build/libs/*.jar

      - name: üîë Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üì¶ Build & push via BuildKit
        run: |
          # Enable BuildKit
          DOCKER_BUILDKIT=1 docker build \
            -f podman/Containerfile \
            -t ${IMAGE_NAME}:${{ needs.build.outputs.VERSION_TAG }} \
            -t ${IMAGE_NAME}:latest \
            .
          docker push ${IMAGE_NAME}:${{ needs.build.outputs.VERSION_TAG }}
          docker push ${IMAGE_NAME}:latest

  

  gitops:
    name: Update Helm values & GitOps
    needs: deploy
    runs-on: ubuntu-latest        # ‚Üê GitHub-hosted runner
    steps:
      - name: üõéÔ∏è Checkout devops-management repo
        uses: actions/checkout@v4
        with:
          repository: keyveloper/devops-management
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîÑ Bump x-frontserver tag in Helm values
        run: |
          cd k8s-helm/helm-values/x-front
          sed -i 's/^  tag: .*$/  tag: '"${{ needs.build.outputs.VERSION_TAG }}"'/' values.yaml

      - name: üíæ Commit & push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add k8s-helm/helm-values/x-front/values.yaml
          git commit -m "ci: bump x-frontserver image to ${{ needs.build.outputs.VERSION_TAG }}"
          git push
